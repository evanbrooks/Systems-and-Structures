<!DOCTYPE html>
<html>
<head>
  <title>Ript shapes</title>
  <link rel="stylesheet" href="css/loader.css" type="text/css" media="screen">
  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen">
</head>
<body>

  <div class="container">


    <nav>
      <select id="route"></select>
      <select id="trip"></select>
      <select id="shape"></select>
      <button id="getShape">Get shape</button>
      <button id="getAllShapes">Get all shapes</button>
      <div class="ajax-loader spinner"></div>
    </nav>

    <div id="map"></div>

    <div id="data"></div>
    <svg>
      <g></g>
    </svg>
    <div id="shapeOutput"></div>


    <style>
      #shapeOutput i{
        position: absolute;
        display: block;
        font-size: 2px;
        -webkit-transition: all 0.2s;
      }

      nav {
        position: fixed;
        top: 10px;
        left: 10px;
        right: 10px;
      }
      .line {
        fill: none;
        stroke: black;
        stroke-width: 3px;
        opacity: 0.2;
      }

      .spinner {
        display: none;
      }

      .loading .spinner {
        display: block;
      }

    </style>

  </div> <!-- /container -->


  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script>

    var Const = {};
    setup();
    var shapeids = [];

    // ---------- Setup ---------------

    function setup(){

      bindings();
      getConstants(
        getRoutes
      );

      function bindings() {
        $('#getShape').on('click', getTripShape);
        $('#getAllShapes').on('click', getAllShapes);
        $('#route').change(getTrips);
        $('#shape').change(function(){
          getShape($(this).val());
        });
      }

      function getConstants(callback) {
        $.getJSON('api/agencies', function(data){
          data.forEach(function(agency){
            if (agency.agency_name == "RIPTA") {
              Const = {
                lat: {
                    min: agency.agency_bounds.sw[1]
                  , max: agency.agency_bounds.ne[1]
                },
                lon: {
                    min: agency.agency_bounds.sw[0]
                  , max: agency.agency_bounds.ne[0]
                },
                scale: 1000,
                agency: agency.agency_name.toLowerCase(),
                center: agency.agency_center
              };
              callback();
            }
          });
        });
      }

      function getRoutes() {
        $.getJSON('api/routes/' + Const.agency, function(data){
          // Put data in order
          data.sort(function(a, b){
           return a.route_short_name-b.route_short_name;
          });
          // Add it to the select
          data.forEach(function(route){
            $("#route")
              .append(
                "<option value=\""
                + route.route_id
                + "\">"
                + route.route_short_name
                + "</option>"
              );
          });
          getTrips();
        });
      }
    }

    // ---------- End Setup ---------------

    function getTripShape() {
      state("load");
      var route = $("#route").val();
      $.getJSON("/api/shape/"+Const.agency+"/"+route+"/", function(data){
        state("endload");
        if(data.length){
          d3
          .select("g")
          .append("svg:path")
          .datum(data)
          .attr("class", "line")
          .attr("d", line);
        }
      });
    }

    // --------

    function getTrips() {
      state("load");
      $("#trip > option").remove();
      $("#shape > option").remove();
      var route = $("#route").val();

      // Get trips
      $.getJSON("/api/trips/"+Const.agency+"/"+route+"/", function(data){
        state("endload");
        //console.log(data);
        data.forEach(function(trip){
          $("#trip")
            .append(
              "<option value=\""
              + trip.trip_id
              + "\">"
              + trip.trip_headsign
              + "</option>"
            );
        });
      });

      // Get shape ids
      $.getJSON("/api/shapeid/"+Const.agency+"/"+route+"/", function(data){
        state("endload");
        shapeids.length = 0; // clears array
        data.forEach(function(shapeid, index, arr){
          $("#shape")
            .append(
              "<option value=\""
              + shapeid
              + "\"> Shape "
              + (index + 1)
              + "</option>"
            );
          shapeids.push(shapeid);
        });
      });
    }

    function getShape(shape) {
      state("load");
      $.getJSON("/api/points/"+Const.agency+"/"+shape+"/", function(data){
        state("endload");
        if(data.length){
          d3
          .select("g")
          .append("svg:path")
          .datum(data)
          .attr("class", "line")
          .attr("d", line);
        }
      });
    }

    function getAllShapes() {
      shapeids.forEach(function(id){
        getShape(id);
      });
    }

    // --------

    var line = d3.svg.line()
    .y(function(d) { return convertLat(d.lat) })
    .x(function(d) { return convertLon(d.lon) })
    .interpolate("basis");


    // Utility functions
    // -----------------

    function convertLat(lat){
      l = -1 * (lat - Const.lat.min) * Const.scale + $(window).height();
      return l; parseInt(l);
    }
    function convertLon(lon){
      l = (lon - Const.lon.min) * Const.scale;
      return l;//parseInt(l);
    }

    function state(str) {
      switch (str) {
        case "load":
          $("body").addClass("loading");
          break;
        case "endload":
          $("body").removeClass("loading");
          break;
      }
    }

  </script>

</body>
</html>
