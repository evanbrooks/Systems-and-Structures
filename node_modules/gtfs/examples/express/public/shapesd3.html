<!DOCTYPE html>
<html>
<head>
  <title>Ript shapes</title>
  <link rel="stylesheet" href="css/loader.css" type="text/css" media="screen">
  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen">
</head>
<body>

  <nav>
    <select id="route"></select>
    <!--<select id="trip"></select>-->
    <!--<select id="shape"></select>-->
    <!--<button id="getAllShapes">Get all shapes</button>-->
    <button id="zoom1">reset zoom</button>
    <input id="zoomslide" type="range" min="1" max="20" value="1" step="0.02"/>
    <span id="currentValue">0</span>
    <div class="ajax-loader spinner"></div>
  </nav>

  <div class="container">

    <svg class="map">
      <g></g>
    </svg>
    <div id="shapeOutput"></div>

  </div> <!-- /container -->


    <style>
      body {
        background: #f4f4f4;
      }

      #shapeOutput i{
        position: absolute;
        display: block;
        font-size: 2px;
        -webkit-transition: all 0.2s;
      }

      nav {
        position: fixed;
        z-index: 9;
        top: 10px;
        left: 10px;
        right: 10px;
      }

      .map {
        margin: auto;
        display:block;
        -webkit-transition: all 0.2s;
        width: 200px;
        height: 200px;
        overflow: visible;
        cursor: -webkit-grab;
      }

      .map-start {
        border: 1px solid #ddd;
      }

      #zoomslide {
        width: 300px;
        height: 7px;
      }

      .line {
        fill: none;
        opacity: 0.1;
      }

      .stop {
        fill: red;
        opacity: 0.2;
      }

      .spinner {
        display: none;
      }

      .loading .spinner {
        display: block;
      }

      .line:hover {
        stroke-width: 2;
        stroke: red;
        opacity: 1;
      }

    </style>

  <div id="zoom-style">
  </div>


  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="js/simplify.min.js"></script>
  <script>

    var Const = {};
    var shapeids = [];
    var routeids = [];
    var allshapes = [];
    var map = d3.select(".map g");

    // ---------- Setup ---------------

    function setup(){
      state("load");
      move.setup(".map");
      buttons.setup();
      getConstants(
        getRoutes
      );

      function getConstants(callback) {
        $.getJSON('api/agencies', function(data){
          data.forEach(function(agency){
            if (agency.agency_name == "RIPTA") {
              Const = {
                lat: {
                    min: agency.agency_bounds.sw[1]
                  , max: agency.agency_bounds.ne[1]
                },
                lon: {
                    min: agency.agency_bounds.sw[0]
                  , max: agency.agency_bounds.ne[0]
                },
                scale: 1000,
                agency: agency.agency_name.toLowerCase(),
                center: agency.agency_center
              };
              $(".map").removeClass("map-start").css({
                "width": (Const.lon.max - Const.lon.min) * Const.scale,
                "height": (Const.lat.max - Const.lat.min) * Const.scale
              });
              setupScales();
              callback();
            }
          });
        });
      }

      function getRoutes() {
        $.getJSON('api/routes/' + Const.agency, function(data){
          // Put data in order
          data.sort(function(a, b){
           return a.route_short_name-b.route_short_name;
          });
          // Add it to the select
          data.forEach(function(route){
            routeids.push(route.route_id);
            $("#route")
              .append(
                "<option value=\""
                + route.route_id
                + "\">"
                + route.route_short_name
                + " "
                + route.route_long_name
                + "</option>"
              );
          });
          getTrips();
        });
      }
    }

    // ---------- End Setup ---------------


    function lineScale(x) {
      // var zoomstyle = "<style>\n"
      //   + ".line { stroke-width: "+ 1 * 1/x + ";   }\n"
      //   + ".stop { stroke-width: "+ 1 * 1/x + ";   }\n"
      //   + "</style>";
      // $("#zoom-style").html(zoomstyle);
    }

    move = {

      start: {x:0, y:0},
      delta: {x:0, y:0},
      dragging: false,

      target: {
        el: null,
        freeze: function(){
          this.el.css("-webkit-transition", "none");
        },
        unfreeze: function(){
          this.el.css("-webkit-transition", "");
        },
        clean: function(){
          this.el.removeAttr("style");
        },
        x: 0,
        y: 0,
        scale: 1,
        draw: function() {
          this.el.css("-webkit-transform", "translate3d("+this.x+"px,"+this.y+"px,0) scale("+this.scale+") ");
        }
      },

      // Setup
      // -----

      setup: function(el) {
        this.bind();
        this.target.el = $(el);
        start    = this.start;
        delta    = this.delta;
        dragging = this.dragging;
        target   = this.target;
      },

      bind: function() {
        h = $(".container");
        h.mousedown( this.begin );
        h.mousemove( this.move );
        h.mouseup( this.end  );
      },

      // Moving
      // ------

      begin: function(event) {
        this.dragging = true;
        start.x = event.pageX - target.x;
        start.y = event.pageY - target.y;
        target.freeze();
      },

      move: function(event) {
        if (this.dragging) {
          target.x = event.pageX - start.x;
          target.y = event.pageY - start.y;
          target.draw();
        }
      },

      end: function(event) {
        this.dragging = false;
        target.unfreeze();
      },

      zoom: function(zoom) {
        // target.scale = zoom;
        // target.draw();
        // target.el.on("webkitTransitionEnd", function(){
        //   target.el.hide().fadeOut().show(); // for some reason this 'refreshes' the svg resolution
        //   lineScale(zoom);
        // });
        latScale.range( [ 300*zoom, 0        ] );
        lonScale.range( [ 0       , 300*zoom ] );
        map.selectAll(".line").attr("d", line);
        map.selectAll(".stop")
        .attr("cx", function(d) { return lonScale(d.lon) })
        .attr("cy", function(d) { return latScale(d.lat) });
      }

    }

    zoom = 1;

    buttons = {
      setup: function() {
        //$('#getShape').on('click', getTripShape);
        $('#getAllShapes').on('click', getAllShapes);
        $('#route').change(getTrips);
        $('#zoomin').on('click', function(){
          zoom += 0.2;
          move.zoom(zoom);
        });
        $('#zoomout').on('click', function(){
          zoom -= 0.2;
          move.zoom(zoom);
        });
        $('#zoom1').on('click', function(){
          move.zoom(1);
          $('#zoomslide').val(1);
          $("#currentValue").html("1");
          move.target.x = 0;
          move.target.y = 0;
          move.target.draw();
        });
        $('#zoomslide').change(function(){
            $("#currentValue").html(this.value);
            move.zoom(this.value);
        });

        $('#shape').change(function(){
          getShape($(this).val());
        });
      }
    }

    function getTrips() {
      //$("#trip > option").remove();
      $("#shape > option").remove();
      var route = $("#route").val();

      // Get shape ids
      $.getJSON("/api/shapeid/"+Const.agency+"/"+route+"/", function(data){
        shapeids.length = 0; // clears array
        data.forEach(function(shapeid, index, arr){
          shapeids.push(shapeid);
        });
        getAllShapes();
      });
    }

    function getShape(shape) {
      $.getJSON("/api/points/"+Const.agency+"/"+shape+"/", function(data){
        if(data.length){
          // Convert labels
          data.forEach(function(pt, index, arr){
            data[index] = { y: pt.lat, x: pt.lon };
          });

          // Simplify path
          var simpleData = simplify(data,0.002);
          allshapes.push(simpleData);
        }
      });
    }

    function getAllShapes() {
      shapeids.forEach(function(id){
        getShape(id);
      });
      doNextRoute();
    }

    // --------

    var currentRouteIndex = 0;
    function doNextRoute() {
      if (currentRouteIndex < routeids.length ){
        currentRouteIndex++;
        $("#route").val(routeids[currentRouteIndex]);
        getTrips();
      }
      else {
        console.log("done");
        map.selectAll(".line")
        .data(allshapes)
        .enter()
        .append("svg:path")
        .attr("d", line)
        .attr("stroke", "black")
        .attr("stroke-width", "1")
        .attr("class", "line");
        state("endload");
      }
    }

    // --------

    function getStopsNearby(lat, lon, radius){
      var stopsNearby = {};

      console.log(Const.center);

      $.getJSON('/api/stopsNearby/' + Const.center[1] + '/' + Const.center[0] + '/500', function(data){
        console.log(data.length + " points");
        if(data.length){
          var allstops = [];
          data.forEach(function(stop){
            stopsNearby[stop.stop_id] = stop;
            //console.log(stop.stop_name);
            allstops.push({
              name: stop.stop_name,
              lat: isNaN(stop.stop_lat) ? 0 : stop.stop_lat,
              lon: isNaN(stop.stop_lon) ? 0 : stop.stop_lon
            });
          });
          createPoints(allstops);
        } else {
          console.log("No stop data");
        }

      });
    }

    function createPoints(allstops) {
      //console.log("new stop at "+lat+", "+lon);
      map.selectAll(".stop")
        .data(allstops)
        .enter()
        .append("circle")
        .attr("class", "stop")
        .attr("cx", function(d) { return lonScale(d.lon) })
        .attr("cy", function(d) { return latScale(d.lat) })
        .attr("r", 1)
    };

    // --------

    var line = d3.svg.line()
    .y(function(d) { return latScale(d.y) })
    .x(function(d) { return lonScale(d.x) })
    .interpolate("basis");

    // Utility functions
    // -----------------

    var latScale, lonScale;
    function setupScales() {
      latScale = d3.scale.linear()
                      .domain([Const.lat.min, Const.lat.max])
                      .range([300, 0]); // reversed because latitude is measured west of meridian
      lonScale = d3.scale.linear()
                      .domain([Const.lon.min, Const.lon.max])
                      .range([0, 300]);
    }

    function d3zoom() {
      map.selectAll(".lines")
                .transition()
                .duration(500)
                .ease("linear")
                .attr("d", line);
    }

    function state(str) {
      switch (str) {
        case "load":
          $("body").addClass("loading");
          break;
        case "endload":
          $("body").removeClass("loading");
          break;
      }
    }

    // Ready...
    setup();

  </script>

</body>
</html>
