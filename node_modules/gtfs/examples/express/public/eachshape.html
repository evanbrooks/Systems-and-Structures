<!DOCTYPE html>
<html>
<head>
  <title>Ript shapes</title>
  <link rel="stylesheet" href="css/loader.css" type="text/css" media="screen">
  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen">
</head>
<body>

  <nav>
    <select id="route" style="display: none;"></select>
    <div class="ajax-loader spinner"></div>
  </nav>

  <div class="content-wrapper">
  </div>


    <style>
      body {
        background: #f4f4f4;
        margin: 0;
        padding: 0;
      }

      #shapeOutput i{
        position: absolute;
        display: block;
        font-size: 2px;
        -webkit-transition: all 0.2s;
      }

      nav {
        position: fixed;
        z-index: 9;
        top: 10px;
        left: 10px;
        right: 10px;
      }

      .container {
        display: inline-block;
        position: relative;
        border-right: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        -webkit-transition: all 1s;
      }

      .map {
        margin: auto;
        display:block;
        -webkit-transition: all 0.2s;
        width: 200px;
        height: 200px;
        cursor: -webkit-grab;
      }

      .map-start {
        border: 1px solid #ddd;
      }

      .line {
        fill: none;
        stroke: black;
        stroke-width: 1px;
        opacity: 0.2;
      }

      .spinner {
        display: none;
      }

      .loading .spinner {
        display: block;
      }

      .container i {
        display: block;
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        bottom: 0;
        -webkit-transition: all 0.8s;
        line-height: 300px;
        font-style: normal;
        font-family: Univers Lt Std;
        text-align: center;
        font-size: 10px;
        pointer-events: none;
      }


/*      .container:hover .line {
        stroke-width:1px;
        opacity: 0.2;
        stroke: red;
      }*/

      .container svg {
        -webkit-transition: all 0.5s;
      }

      .content-wrapper:hover .container {
        opacity: 0.4;
      }

      .content-wrapper .container:hover {
        opacity: 1;
        z-index: 9;
      }

      .container:hover svg {
        -webkit-transform: scale(2);
      }

      .container:hover .line {
        stroke-width: 0.5;
      }

      .container:hover .line:hover {
        stroke-width: 1;
        stroke: red;
        opacity: 1;
      }

    </style>

  <div id="zoom-style">
  </div>

  <div id="svg-size">
  </div>


  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="js/soundmanager2-jsmin.js"></script>
  <script src="js/simplify.min.js"></script>
  <script>

    var Const = {};
    var shapeids = [];
    var routeids = [];

    // ---------- Setup ---------------

    function setup(){

      move.setup(".map");
      buttons.setup();
      getConstants(
        getRoutes
      );

      function getConstants(callback) {
        $.getJSON('api/agencies', function(data){
          data.forEach(function(agency){
            if (agency.agency_name == "RIPTA") {
              Const = {
                lat: {
                    min: agency.agency_bounds.sw[1]
                  , max: agency.agency_bounds.ne[1]
                },
                lon: {
                    min: agency.agency_bounds.sw[0]
                  , max: agency.agency_bounds.ne[0]
                },
                scale: 500,
                agency: agency.agency_name.toLowerCase(),
                center: agency.agency_center
              };
              $(".map").removeClass("map-start");
              var w = (Const.lon.max - Const.lon.min) * Const.scale;
              var h = (Const.lat.max - Const.lat.min) * Const.scale;
              svgSize(w,h);
              callback();
            }
          });
        });
      }

      function getRoutes() {
        $.getJSON('api/routes/' + Const.agency, function(data){
          // Put data in order
          data.sort(function(a, b){
           return a.route_short_name-b.route_short_name;
          });
          // Add it to the select
          data.forEach(function(route){
            routeids.push(route.route_id);
            $("#route")
              .append(
                "<option value=\""
                + route.route_id
                + "\">"
                + route.route_short_name
                + " "
                + route.route_long_name
                + "</option>"
              );
          });
          getTrips();
        });
      }
    }

    // ---------- End Setup ---------------


    function lineScale(x) {
      var zoomstyle = "<style>\n"
        + ".line { stroke-width: "+ 1 * 1/x + ";   }\n"
        + "</style>";
      $("#zoom-style").html(zoomstyle);
    }

    function svgSize(w, h) {
      var zoomstyle = "<style>\n"
        + ".container svg { width: "+ w + "px; height: "+ h + "px;   }\n"
        + "</style>";
      $("#zoom-style").html(zoomstyle);
    }

    move = {

      start: {x:0, y:0},
      delta: {x:0, y:0},
      dragging: false,

      target: {
        el: null,
        freeze: function(){
          this.el.css("-webkit-transition", "none");
        },
        unfreeze: function(){
          this.el.css("-webkit-transition", "");
        },
        clean: function(){
          this.el.removeAttr("style");
        },
        x: 0,
        y: 0,
        scale: 1,
        draw: function() {
          this.el.css("-webkit-transform", "translate3d("+this.x+"px,"+this.y+"px,0) scale("+this.scale+") ");
        }
      },

      // Setup
      // -----

      setup: function(el) {
        this.bind();
        this.target.el = $(el);
        start    = this.start;
        delta    = this.delta;
        dragging = this.dragging;
        target   = this.target;
      },

      bind: function() {
        h = $(".container");
        h.mousedown( this.begin );
        h.mousemove( this.move );
        h.mouseup( this.end  );
      },

      // Moving
      // ------

      begin: function(event) {
        this.dragging = true;
        start.x = event.pageX - target.x;
        start.y = event.pageY - target.y;
        target.freeze();
      },

      move: function(event) {
        if (this.dragging) {
          target.x = event.pageX - start.x;
          target.y = event.pageY - start.y;
          target.draw();
        }
      },

      end: function(event) {
        this.dragging = false;
        target.unfreeze();
      },

      zoom: function(zoom) {
        target.scale = zoom;
        target.draw();
        target.el.on("webkitTransitionEnd", function(){
          target.el.hide().fadeOut().show(); // for some reason this 'refreshes' the svg resolution
          lineScale(zoom);
        });
      }

    }

    buttons = {
      setup: function() {
        $('#getAllShapes').on('click', getAllShapes);
        $('#route').change(getTrips);
        $('#shape').change(function(){
          getShape($(this).val());
        });
      }
    }

    // --------

    function getTrips() {
      state("load");
      $("#shape > option").remove();
      $(".map .line").remove();
      var route = $("#route").val();
      $(".content-wrapper").append("<div class=\"container new\"><i class=\"route\"></i><svg><g></g></svg></div>");
      $(".container.new").removeClass("new").addClass("route-"+route).find("i").html(route);

      // Get shape ids
      $.getJSON("/api/shapeid/"+Const.agency+"/"+route+"/", function(data){
        state("endload");
        shapeids.length = 0; // clears array
        data.forEach(function(shapeid, index, arr){
          shapeids.push(shapeid);
        });
        getAllShapes();
      });
    }

    function getShape(shape) {
      state("load");
      var route = $("#route").val();
      $.getJSON("/api/points/"+Const.agency+"/"+shape+"/", function(data){
        state("endload");
        if(data.length){
          // Convert labels
          data.forEach(function(pt, index, arr){
            data[index] = { y: convertLat(pt.lat), x: convertLon(pt.lon) };
          });

          // Simplify path
          var simpleData = simplify(data,3);

          // Draw line
          d3
          .select(".route-"+route+" g")
          .append("svg:path")
          .datum(simpleData)
          .attr("class", "line")
          .attr("d", line);
        }
      });
    }

    function getAllShapes() {
      shapeids.forEach(function(id){
        getShape(id);
      });
      doNextRoute();
    }

    // --------

    var currentRouteIndex = 0;
    function doNextRoute() {
      if (currentRouteIndex < routeids.length ){
        currentRouteIndex++;
        $("#route").val(routeids[currentRouteIndex]);
        getTrips();
      }
      else {
        console.log("done");
      }
    }

    // --------

    var line = d3.svg.line()
    .y(function(d) { return d.y })
    .x(function(d) { return d.x })
    .interpolate("basis");


    // Utility functions
    // -----------------

    function convertLat(lat){
      latRange = Const.lat.max - Const.lat.min;
      l = -1 * (lat - Const.lat.min) * Const.scale + latRange * Const.scale;
      //   ^ b/c longitude is measured west from prive meridian
      return l;//parseInt(l);
    }
    function convertLon(lon){
      l = (lon - Const.lon.min) * Const.scale;
      return l;//parseInt(l);
    }

    function state(str) {
      switch (str) {
        case "load":
          $("body").addClass("loading");
          break;
        case "endload":
          $("body").removeClass("loading");
          break;
      }
    }

    // Ready...
    setup();

  </script>

  <script>
  soundManager.setup({
    url: 'swf/',
    flashVersion: 9, // optional: shiny features (default = 8)
    useFlashBlock: false, // optionally, enable when you're ready to dive in
    /**
     * read up on HTML5 audio support, if you're feeling adventurous.
     * iPad/iPhone and devices without flash installed will always attempt to use it.
     */
    onready: function() {
      // Ready to use; soundManager.createSound() etc. can now be called.
    }
  });
  </script>

</body>
</html>
